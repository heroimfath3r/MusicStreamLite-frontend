# ============================================================
# Google Cloud Build Configuration - Frontend
# ============================================================
# Proyecto: MusicStream Lite
# Servicio: React Frontend
# Regi√≥n: us-central1
# Descripci√≥n: Build, test, escaneo de seguridad y deploy a Cloud Run
# ============================================================

# ============================================================
# GLOBAL SUBSTITUTIONS (Variables)
# ============================================================
substitutions:
  _FRONTEND_SERVICE_NAME: 'musicstream-frontend'
  _REGION: 'us-central1'
  _ARTIFACT_REGISTRY: 'us-central1-docker.pkg.dev'
  _REPOSITORY: 'musicstream'
  _DOMAIN: 'musicstreamlite.com'  # Tu dominio
  _DNS_ZONE: 'musicstream-zone'    # Tu zona DNS
  _SLACK_WEBHOOK: ''               # Se obtiene de Secret Manager
  _SENTRY_DSN: ''                  # Se obtiene de Secret Manager
  _GA_TRACKING_ID: ''              # Se obtiene de Secret Manager
  _HASH: 'abc123'                  # Placeholder para service URLs

# ============================================================
# BUILD STEPS
# ============================================================
steps:

  # ============================================================
  # STEP 1: Instalar dependencias
  # ============================================================
  - name: 'node:18-alpine'
    id: 'install-dependencies'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "üì¶ [STEP 1] Instalando dependencias del frontend..."
        cd frontend/react-app
        
        # Instalar solo dependencias de producci√≥n
        npm ci --only=production --audit=false --prefer-offline
        
        echo "‚úÖ Dependencias instaladas correctamente"
        echo "   Versi√≥n de Node: $(node --version)"
        echo "   Versi√≥n de npm: $(npm --version)"

  # ============================================================
  # STEP 2: Ejecutar tests
  # ============================================================
  - name: 'node:18-alpine'
    id: 'run-tests'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "üß™ [STEP 2] Ejecutando tests unitarios..."
        cd frontend/react-app
        
        # Ejecutar tests con cobertura
        npm test -- \
          --watchAll=false \
          --coverage \
          --passWithNoTests \
          --testPathIgnorePatterns=e2e \
          --maxWorkers=2
        
        echo "‚úÖ Tests completados exitosamente"

  # ============================================================
  # STEP 3: ESLint (Code Quality)
  # ============================================================
  - name: 'node:18-alpine'
    id: 'run-lint'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "üîç [STEP 3] Ejecutando ESLint..."
        cd frontend/react-app
        
        # Ejecutar ESLint con reporte
        npx eslint src/ \
          --ext .js,.jsx,.ts,.tsx \
          --max-warnings=0 \
          --format=compact
        
        echo "‚úÖ Linting completado - Sin errores"
    allowFailure: true  # No bloquea el build si hay warnings

  # ============================================================
  # STEP 4: Build de aplicaci√≥n React
  # ============================================================
  - name: 'node:18-alpine'
    id: 'build-react'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "üèóÔ∏è  [STEP 4] Compilando aplicaci√≥n React..."
        cd frontend/react-app
        
        # Crear archivo .env.production con variables de build
        cat > .env.production << 'EOL'
        # URLs de APIs
        REACT_APP_CATALOG_URL=https://catalog-service-${_REGION}.run.app
        REACT_APP_USER_SERVICE_URL=https://user-service-${_REGION}.run.app
        REACT_APP_ANALYTICS_URL=https://analytics-service-${_REGION}.run.app
        
        # Configuraci√≥n de entorno
        REACT_APP_ENV=production
        REACT_APP_VERSION=${TAG_NAME:-${SHORT_SHA}}
        REACT_APP_BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
        
        # Integraciones opcionales
        REACT_APP_SENTRY_DSN=${_SENTRY_DSN}
        REACT_APP_GA_TRACKING_ID=${_GA_TRACKING_ID}
        
        # Feature flags
        REACT_APP_ENABLE_ANALYTICS=true
        REACT_APP_ENABLE_OFFLINE_MODE=true
        REACT_APP_ENABLE_PWA=true
        EOL
        
        echo "üìù Variables de entorno configuradas"
        
        # Ejecutar build con an√°lisis de performance
        CI=false npm run build
        
        echo "‚úÖ Build de React completado"
        echo "   Tama√±o del bundle: $(du -sh build/ | cut -f1)"
        
        # Crear archivo de informaci√≥n del build
        cat > build/build-info.txt << EOL
        Build Information
        ================
        Commit SHA: ${SHORT_SHA}
        Tag: ${TAG_NAME:-latest}
        Build Date: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
        Branch: ${BRANCH_NAME:-main}
        Repository: ${REPO_NAME}
        EOL

  # ============================================================
  # STEP 5: An√°lisis de seguridad de dependencias
  # ============================================================
  - name: 'node:18-alpine'
    id: 'security-scan'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "üîí [STEP 5] Escaneando vulnerabilidades de dependencias..."
        cd frontend/react-app
        
        # Ejecutar npm audit
        if npm audit --audit-level=high 2>&1 | tee audit-report.txt; then
          echo "‚úÖ No hay vulnerabilidades de seguridad"
        else
          echo "‚ö†Ô∏è  Se encontraron vulnerabilidades - Revisando severidad..."
          # Permitir que contin√∫e si son vulnerabilidades bajas/medias
          if grep -q "high\|critical" audit-report.txt; then
            echo "‚ùå Vulnerabilidades CR√çTICAS encontradas"
            exit 1
          fi
        fi
        
        echo "‚úÖ Escaneo de seguridad completado"
    allowFailure: false

  # ============================================================
  # STEP 6: Construir imagen Docker
  # ============================================================
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-docker-image'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "üê≥ [STEP 6] Construyendo imagen Docker..."
        
        # Verificar que existe el Dockerfile
        if [ ! -f "frontend/react-app/Dockerfile.prod" ]; then
          echo "‚ùå Dockerfile.prod no encontrado"
          exit 1
        fi
        
        # Build con BuildKit para mejor cach√©
        docker build \
          --build-arg NODE_ENV=production \
          --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
          --build-arg VCS_REF=${SHORT_SHA} \
          --build-arg VERSION=${TAG_NAME:-latest} \
          -t ${_ARTIFACT_REGISTRY}/${PROJECT_ID}/${_REPOSITORY}/frontend:${SHORT_SHA} \
          -t ${_ARTIFACT_REGISTRY}/${PROJECT_ID}/${_REPOSITORY}/frontend:latest \
          -t ${_ARTIFACT_REGISTRY}/${PROJECT_ID}/${_REPOSITORY}/frontend:${TAG_NAME:-main} \
          -f frontend/react-app/Dockerfile.prod \
          frontend/react-app
        
        echo "‚úÖ Imagen Docker construida correctamente"
        docker images | grep frontend

  # ============================================================
  # STEP 7: Escanear vulnerabilidades de la imagen Docker
  # ============================================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'scan-docker-image'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "üîç [STEP 7] Escaneando imagen Docker..."
        
        # Escanear imagen en Artifact Registry
        echo "Esperando a que se complete el escaneo..."
        
        gcloud artifacts docker images scan \
          ${_ARTIFACT_REGISTRY}/${PROJECT_ID}/${_REPOSITORY}/frontend:${SHORT_SHA} \
          --severity-threshold=HIGH \
          --format="table(name, vulnerability.id, vulnerability.severity)" \
          || echo "‚ö†Ô∏è  Escaneo completado con posibles findings - Revisando..."
        
        echo "‚úÖ Escaneo de imagen completado"
    allowFailure: true  # No bloquea si hay findings bajos

  # ============================================================
  # STEP 8: Push a Artifact Registry
  # ============================================================
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-to-artifact-registry'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "üì§ [STEP 8] Subiendo imagen a Artifact Registry..."
        
        # Push de todas las etiquetas
        echo "Subiendo ${SHORT_SHA}..."
        docker push ${_ARTIFACT_REGISTRY}/${PROJECT_ID}/${_REPOSITORY}/frontend:${SHORT_SHA}
        
        echo "Subiendo latest..."
        docker push ${_ARTIFACT_REGISTRY}/${PROJECT_ID}/${_REPOSITORY}/frontend:latest
        
        if [ ! -z "${TAG_NAME}" ]; then
          echo "Subiendo ${TAG_NAME}..."
          docker push ${_ARTIFACT_REGISTRY}/${PROJECT_ID}/${_REPOSITORY}/frontend:${TAG_NAME}
        fi
        
        echo "‚úÖ Imagen subida exitosamente"

  # ============================================================
  # STEP 9: Deploy a Cloud Run
  # ============================================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-to-cloud-run'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "üöÄ [STEP 9] Desplegando a Cloud Run..."
        
        # Deploy del servicio
        gcloud run deploy ${_FRONTEND_SERVICE_NAME} \
          --image=${_ARTIFACT_REGISTRY}/${PROJECT_ID}/${_REPOSITORY}/frontend:${SHORT_SHA} \
          --region=${_REGION} \
          --platform=managed \
          --allow-unauthenticated \
          --memory=512Mi \
          --cpu=1 \
          --max-instances=5 \
          --min-instances=0 \
          --concurrency=80 \
          --timeout=300s \
          --port=3000 \
          --set-env-vars=\
        NODE_ENV=production,\
        REACT_APP_ANALYTICS_URL=https://analytics-service-${_REGION}.run.app,\
        REACT_APP_USER_SERVICE_URL=https://user-service-${_REGION}.run.app,\
        REACT_APP_CATALOG_URL=https://catalog-service-${_REGION}.run.app \
          --labels=commit-sha=${SHORT_SHA},\
        version=${TAG_NAME:-latest},\
        service=frontend,\
        environment=production \
          --no-traffic  # Comenzar sin tr√°fico para validar
        
        echo "‚úÖ Deployment inicial completado"
        
        # Obtener URL del servicio
        SERVICE_URL=$(gcloud run services describe ${_FRONTEND_SERVICE_NAME} \
          --region=${_REGION} \
          --format='value(status.url)')
        
        echo "üåê Servicio en: $SERVICE_URL"

  # ============================================================
  # STEP 10: Health Check Post-Deploy
  # ============================================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'health-check'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "üè• [STEP 10] Verificando salud del servicio..."
        
        SERVICE_URL=$(gcloud run services describe ${_FRONTEND_SERVICE_NAME} \
          --region=${_REGION} \
          --format='value(status.url)')
        
        echo "Esperando a que el servicio est√© listo..."
        sleep 10
        
        # Health check con reintentos
        MAX_RETRIES=5
        RETRY=0
        
        while [ $RETRY -lt $MAX_RETRIES ]; do
          echo "Intento $((RETRY+1))/$MAX_RETRIES..."
          
          if curl -f --connect-timeout 5 --max-time 10 "$SERVICE_URL" > /dev/null 2>&1; then
            echo "‚úÖ Health check exitoso"
            break
          fi
          
          RETRY=$((RETRY+1))
          if [ $RETRY -lt $MAX_RETRIES ]; then
            echo "‚è≥ Reintentando en 5 segundos..."
            sleep 5
          fi
        done
        
        if [ $RETRY -eq $MAX_RETRIES ]; then
          echo "‚ùå Health check fall√≥ despu√©s de $MAX_RETRIES intentos"
          exit 1
        fi

  # ============================================================
  # STEP 11: Validar Despliegue (Traffic Split)
  # ============================================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'validate-deployment'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "‚úîÔ∏è  [STEP 11] Validando despliegue..."
        
        SERVICE_URL=$(gcloud run services describe ${_FRONTEND_SERVICE_NAME} \
          --region=${_REGION} \
          --format='value(status.url)')
        
        # Ejecutar validaciones b√°sicas
        echo "Verificando respuesta HTML..."
        RESPONSE=$(curl -s -w "%{http_code}" -o response.html "$SERVICE_URL")
        
        if [ "$RESPONSE" -eq 200 ]; then
          echo "‚úÖ Respuesta HTTP 200 OK"
          
          # Verificar que es HTML v√°lido
          if grep -q "<!DOCTYPE html>" response.html; then
            echo "‚úÖ Contenido HTML v√°lido"
          fi
        else
          echo "‚ùå Respuesta HTTP $RESPONSE"
          exit 1
        fi
        
        # Dirigir 100% del tr√°fico a la nueva versi√≥n
        echo "Dirigiendo tr√°fico a la nueva versi√≥n..."
        gcloud run services update-traffic ${_FRONTEND_SERVICE_NAME} \
          --to-revisions LATEST=100 \
          --region=${_REGION}
        
        echo "‚úÖ Validaci√≥n completada - Tr√°fico dirigido a nueva versi√≥n"

  # ============================================================
  # STEP 12: E2E Tests (Opcional)
  # ============================================================
  - name: 'node:18-alpine'
    id: 'e2e-tests'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "üéØ [STEP 12] Ejecutando E2E tests..."
        
        SERVICE_URL=$(gcloud run services describe ${_FRONTEND_SERVICE_NAME} \
          --region=${_REGION} \
          --format='value(status.url)')
        
        echo "Validando servicio en: $SERVICE_URL"
        
        # Test b√°sicos de E2E
        echo "Verificando ruta ra√≠z..."
        curl -f "$SERVICE_URL" > /dev/null && echo "‚úÖ Ra√≠z respondiendo"
        
        echo "Verificando assets est√°ticos..."
        curl -f "$SERVICE_URL/static/" 2>/dev/null && echo "‚úÖ Assets disponibles" || echo "‚ö†Ô∏è  Assets route (esperado en algunos casos)"
        
        echo "‚úÖ E2E tests completados"
    allowFailure: true  # No bloquea si falla

  # ============================================================
  # STEP 13: Notificaciones (Slack, etc)
  # ============================================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'send-notification'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "üì¢ [STEP 14] Enviando notificaci√≥n de despliegue..."
        
        SERVICE_URL=$(gcloud run services describe ${_FRONTEND_SERVICE_NAME} \
          --region=${_REGION} \
          --format='value(status.url)')
        
        # Preparar mensaje
        COMMIT_MESSAGE=$(git log -1 --pretty=%B 2>/dev/null || echo "N/A")
        AUTHOR=$(git log -1 --pretty=%an 2>/dev/null || echo "unknown")
        
        # Enviar a Slack si el webhook est√° configurado
        if [ ! -z "${_SLACK_WEBHOOK}" ]; then
          echo "Enviando a Slack..."
          
          curl -X POST \
            -H 'Content-type: application/json' \
            --data "{
              \"text\": \"üéµ MusicStream Frontend - Despliegue Exitoso\",
              \"blocks\": [
                {
                  \"type\": \"header\",
                  \"text\": {
                    \"type\": \"plain_text\",
                    \"text\": \"‚úÖ Frontend Deployment Successful\"
                  }
                },
                {
                  \"type\": \"section\",
                  \"fields\": [
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Versi√≥n:*\n${SHORT_SHA}\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Ambiente:*\nProduction\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Autor:*\n${AUTHOR}\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Regi√≥n:*\n${_REGION}\"
                    }
                  ]
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"<${SERVICE_URL}|Visitar Servicio> ‚Ä¢ Commit: ${SHORT_SHA}\"
                  }
                }
              ]
            }" \
            "${_SLACK_WEBHOOK}" \
            || echo "‚ö†Ô∏è  Fallo al enviar a Slack"
        fi
        
        echo "‚úÖ Notificaci√≥n enviada"
    allowFailure: true

# ============================================================
# CONFIGURACI√ìN GENERAL DEL BUILD
# ============================================================

# Timeout total del build (20 minutos)
timeout: '1200s'

# Tipo de m√°quina y logging
options:
  machineType: 'E2_HIGHCPU_4'  # 4 CPUs, cost-effective
  logging: CLOUD_LOGGING_ONLY
  diskSizeGb: 100               # Espacio para build y cach√©
  
  # Cach√©s para mejorar builds posteriores
  substitutionOption: 'ALLOW_LOOSE'

# ============================================================
# ARTEFACTOS A ALMACENAR
# ============================================================
artifacts:
  objects:
    location: 'gs://${PROJECT_ID}_cloudbuild/frontend/'
    paths:
      - 'frontend/react-app/build/**/*'           # Build production
      - 'frontend/react-app/coverage/**/*'        # Reporte de cobertura
      - 'frontend/react-app/audit-report.txt'     # Reporte de seguridad
      - 'frontend/react-app/build-info.txt'       # Info del build

# ============================================================
# ETIQUETAS DEL BUILD
# ============================================================
tags:
  - 'gcp-cloud-build'
  - 'frontend'
  - 'react'
  - 'musicstream-lite'
  - 'production'
  - 'us-central1'

# ============================================================
# SECRETOS DESDE SECRET MANAGER
# ============================================================
availableSecrets:
  secretManager:
    # Slack Webhook para notificaciones
    - versionName: 'projects/${PROJECT_ID}/secrets/slack-webhook/versions/latest'
      env: '_SLACK_WEBHOOK'
    
    # Sentry DSN para error tracking
    - versionName: 'projects/${PROJECT_ID}/secrets/sentry-dsn/versions/latest'
      env: '_SENTRY_DSN'
    
    # Google Analytics
    - versionName: 'projects/${PROJECT_ID}/secrets/ga-tracking-id/versions/latest'
      env: '_GA_TRACKING_ID'

# ============================================================
# COMENTARIOS Y NOTAS IMPORTANTES
# ============================================================

# üìù NOTAS DE CONFIGURACI√ìN:
#
# 1. VARIABLES PERSONALIZABLES:
#    - Cambia _FRONTEND_SERVICE_NAME a tu nombre de servicio
#    - Actualiza _REGION seg√∫n tu ubicaci√≥n
#    - Configura _DOMAIN si usas dominio personalizado
#
# 2. SECRETOS A CREAR EN SECRET MANAGER:
#    gcloud secrets create slack-webhook --data-file=-
#    gcloud secrets create sentry-dsn --data-file=-
#    gcloud secrets create ga-tracking-id --data-file=-
#
# 3. PERMISOS REQUERIDOS:
#    - Cloud Build Editor
#    - Cloud Run Admin
#    - Service Account User
#    - Artifact Registry Writer
#
# 4. DOCKERFILE.PROD DEBE EXISTIR EN:
#    frontend/react-app/Dockerfile.prod
#
# 5. COSTO:
#    Este build usa m√°quina E2_HIGHCPU_4 = ~$0.028/min
#    Build t√≠pico: 10-15 minutos = $0.30-$0.42 por build
#
# 6. OPTIMIZACIONES APLICADAS:
#    ‚úì Alpine Linux para im√°genes m√°s peque√±as
#    ‚úì Multi-stage builds (en Dockerfile)
#    ‚úì npm ci para instancias reproducibles
#    ‚úì Health checks post-deploy
#    ‚úì Validaci√≥n de despliegue antes de tr√°fico
#    ‚úì M√©tricas y notificaciones
#
# 7. TROUBLESHOOTING:
#    - Si el build falla en docker push: Verifica permisos de Artifact Registry
#    - Si el health check falla: El servicio puede tardar m√°s en estar listo
#    - Si los secretos no se cargan: Verifica que existen en Secret Manager

# ============================================================