# .github/workflows/deploy-catalog.yml
# CI/CD automatizado para Catalog Service

name: üöÄ Deploy Catalog Service

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'backend/catalog-service/**'
      - '.github/workflows/deploy-catalog.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'backend/catalog-service/**'

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  SERVICE_NAME: catalog-service
  REGION: europe-west1

jobs:
  # ========================================
  # JOB 1: An√°lisis de Seguridad
  # ========================================
  security-scan:
    name: üîí An√°lisis de Seguridad
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîç Escaneo de secretos con TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./backend/catalog-service
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

      - name: üìä An√°lisis de vulnerabilidades (npm audit)
        working-directory: backend/catalog-service
        run: |
          npm audit --audit-level=moderate || true

  # ========================================
  # JOB 2: Tests (si existen)
  # ========================================
  test:
    name: üß™ Tests
    runs-on: ubuntu-latest
    needs: security-scan
    
    steps:
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: backend/catalog-service/package-lock.json

      - name: üì• Instalar dependencias
        working-directory: backend/catalog-service
        run: npm ci

      - name: üß™ Ejecutar tests
        working-directory: backend/catalog-service
        run: npm test || echo "No hay tests configurados"

  # ========================================
  # JOB 3: Build y Deploy a Cloud Run
  # ========================================
  deploy:
    name: üöÄ Deploy a Cloud Run
    runs-on: ubuntu-latest
    needs: [security-scan, test]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v4

      # Autenticaci√≥n con Google Cloud usando Workload Identity
      - name: üîê Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: ‚òÅÔ∏è Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # Build y push usando Cloud Build
      - name: üèóÔ∏è Build con Cloud Build
        run: |
          gcloud builds submit \
            --config=backend/catalog-service/cloudbuild.yaml \
            --substitutions=COMMIT_SHA=${{ github.sha }},_SERVICE_NAME=${{ env.SERVICE_NAME }} \
            .

      - name: üìù Obtener URL del servicio
        id: get-url
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)')
          echo "url=$SERVICE_URL" >> $GITHUB_OUTPUT
          echo "‚úÖ Servicio desplegado en: $SERVICE_URL"

      - name: üè• Health Check
        run: |
          sleep 30
          curl -f ${{ steps.get-url.outputs.url }}/health || exit 1
          echo "‚úÖ Health check exitoso"

      - name: üìä Resumen del Deploy
        run: |
          echo "## üöÄ Deploy Exitoso - Catalog Service" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Servicio:** ${{ env.SERVICE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Regi√≥n:** ${{ env.REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **URL:** ${{ steps.get-url.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Autor:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

  # ========================================
  # JOB 4: Rollback autom√°tico (si falla)
  # ========================================
  rollback:
    name: ‚è™ Rollback (si falla)
    runs-on: ubuntu-latest
    needs: deploy
    if: failure() && github.ref == 'refs/heads/main'
    
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: üîê Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: ‚òÅÔ∏è Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: ‚è™ Rollback a versi√≥n anterior
        run: |
          echo "‚ùå Deploy fall√≥, ejecutando rollback..."
          PREVIOUS_REVISION=$(gcloud run revisions list \
            --service=${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --limit=2 \
            --format='value(name)' | tail -n 1)
          
          if [ -n "$PREVIOUS_REVISION" ]; then
            gcloud run services update-traffic ${{ env.SERVICE_NAME }} \
              --region=${{ env.REGION }} \
              --to-revisions=$PREVIOUS_REVISION=100
            echo "‚úÖ Rollback completado a: $PREVIOUS_REVISION"
          else
            echo "‚ö†Ô∏è No hay versi√≥n anterior para rollback"
          fi