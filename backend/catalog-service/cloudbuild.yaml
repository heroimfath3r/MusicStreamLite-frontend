# backend/catalog-service/cloudbuild.yaml
# CI/CD para Catalog Service en Google Cloud

steps:
  # ============================================================
  # STEP 1: Build de la imagen Docker
  # ============================================================
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-image'
    args:
      - 'build'
      - '-t'
      - 'gcr.io/$PROJECT_ID/catalog-service:$COMMIT_SHA'
      - '-t'
      - 'gcr.io/$PROJECT_ID/catalog-service:latest'
      - '-f'
      - 'Dockerfile.prod'
      - '.'
    dir: 'backend/catalog-service'

  # ============================================================
  # STEP 2: Push de la imagen a Container Registry
  # ============================================================
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-image'
    args:
      - 'push'
      - 'gcr.io/$PROJECT_ID/catalog-service:$COMMIT_SHA'
    waitFor: ['build-image']

  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-latest'
    args:
      - 'push'
      - 'gcr.io/$PROJECT_ID/catalog-service:latest'
    waitFor: ['build-image']

  # ============================================================
  # STEP 3: Escaneo de vulnerabilidades (opcional pero recomendado)
  # ============================================================
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'scan-image'
    args:
      - 'container'
      - 'images'
      - 'scan'
      - 'gcr.io/$PROJECT_ID/catalog-service:$COMMIT_SHA'
    waitFor: ['push-image']
    # Continuar incluso si el escaneo falla (puedes cambiarlo a true)
    allowFailure: true

  # ============================================================
  # STEP 4: Deploy a Cloud Run
  # ============================================================
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'deploy-cloud-run'
    args:
      - 'run'
      - 'deploy'
      - 'catalog-service'
      - '--image=gcr.io/$PROJECT_ID/catalog-service:$COMMIT_SHA'
      - '--region=europe-west1'
      - '--platform=managed'
      - '--allow-unauthenticated'
      - '--memory=512Mi'
      - '--cpu=1'
      - '--min-instances=0'
      - '--max-instances=10'
      - '--port=8080'
      - '--timeout=300'
      - '--concurrency=80'
      # Variables de entorno públicas
      - '--set-env-vars=NODE_ENV=production,PORT=8080,LOG_LEVEL=info'
      # Secrets desde Secret Manager
      - '--set-secrets=DB_HOST=db-host:latest,DB_PORT=db-port:latest,DB_NAME=db-name:latest,DB_USER=db-user:latest,DB_PASSWORD=db-password:latest'
      # VPC para comunicación privada con Cloud SQL
      - '--vpc-connector=projects/$PROJECT_ID/locations/europe-west1/connectors/musicstream-connector'
      - '--vpc-egress=private-ranges-only'
      # Service Account con permisos limitados
      - '--service-account=catalog-service@$PROJECT_ID.iam.gserviceaccount.com'
    waitFor: ['push-image', 'scan-image']

  # ============================================================
  # STEP 5: Health Check post-deploy
  # ============================================================
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'health-check'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        SERVICE_URL=$(gcloud run services describe catalog-service \
          --region=europe-west1 \
          --format='value(status.url)')
        echo "Service URL: $SERVICE_URL"
        sleep 15
        curl -f "$SERVICE_URL/health" || exit 1
    waitFor: ['deploy-cloud-run']

# ============================================================
# Configuración de imágenes a guardar
# ============================================================
images:
  - 'gcr.io/$PROJECT_ID/catalog-service:$COMMIT_SHA'
  - 'gcr.io/$PROJECT_ID/catalog-service:latest'

# ============================================================
# Opciones adicionales
# ============================================================
timeout: 1200s  # 20 minutos máximo

options:
  machineType: 'N1_HIGHCPU_8'
  logging: CLOUD_LOGGING_ONLY
  substitutionOption: 'ALLOW_LOOSE'

# ============================================================
# Sustituciones disponibles
# ============================================================
substitutions:
  _SERVICE_NAME: 'catalog-service'
  _REGION: 'europe-west1'