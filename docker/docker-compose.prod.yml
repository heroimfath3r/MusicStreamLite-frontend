version: '3.8'

services:
  # ==========================================================================
  # FRONTEND APPLICATION
  # ==========================================================================
  frontend:
    build:
      context: ..
      dockerfile: docker/Dockerfile.prod
    container_name: musicstream-frontend-prod
    environment:
      - API_URL=${API_URL:-https://api.musicstream.example.com}
      - NODE_ENV=production
      - REACT_APP_VERSION=${APP_VERSION:-1.0.0}
      - REACT_APP_SENTRY_DSN=${SENTRY_DSN}
      - REACT_APP_GA_TRACKING_ID=${GA_TRACKING_ID}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=Host(`${DOMAIN:-musicstream.example.com}`)"
      - "traefik.http.routers.frontend.entrypoints=websecure"
      - "traefik.http.routers.frontend.tls.certresolver=myresolver"
      - "traefik.http.routers.frontend.tls.domains[0].main=${DOMAIN:-musicstream.example.com}"
      - "traefik.http.routers.frontend.tls.domains[0].sans=www.${DOMAIN:-musicstream.example.com}"
      - "traefik.http.services.frontend.loadbalancer.server.port=8080"
      - "traefik.http.middlewares.frontend-compress.compress=true"
      - "traefik.http.routers.frontend.middlewares=frontend-compress"
      # Security headers
      - "traefik.http.middlewares.frontend-security.headers.sslredirect=true"
      - "traefik.http.middlewares.frontend-security.headers.stsseconds=31536000"
      - "traefik.http.middlewares.frontend-security.headers.stsincludesubdomains=true"
      - "traefik.http.middlewares.frontend-security.headers.stspreload=true"
      - "traefik.http.middlewares.frontend-security.headers.forcestsheader=true"
      - "traefik.http.middlewares.frontend-security.headers.customresponseheaders.X-Content-Type-Options:nosniff"
      - "traefik.http.middlewares.frontend-security.headers.customresponseheaders.X-Frame-Options:DENY"
      - "traefik.http.middlewares.frontend-security.headers.customresponseheaders.X-XSS-Protection:1; mode=block"
      - "traefik.http.middlewares.frontend-security.headers.customresponseheaders.Referrer-Policy:strict-origin-when-cross-origin"
      - "traefik.http.routers.frontend.middlewares=frontend-security"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - frontend-prod-network
    restart: unless-stopped
    deploy:
      replicas: 3
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 10s
        order: stop-first
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.25'
      placement:
        constraints:
          - node.role == worker

  # ==========================================================================
  # REVERSE PROXY (TRAEFIK)
  # ==========================================================================
  traefik:
    image: traefik:v2.10
    container_name: musicstream-frontend-traefik
    command:
      - --api.dashboard=true
      - --api.insecure=true
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --providers.docker.network=frontend-prod-network
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --certificatesresolvers.myresolver.acme.tlschallenge=true
      - --certificatesresolvers.myresolver.acme.email=${ACME_EMAIL:-admin@musicstream.com}
      - --certificatesresolvers.myresolver.acme.storage=/letsencrypt/acme.json
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"  # Traefik dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik_letsencrypt:/letsencrypt
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml
    networks:
      - frontend-prod-network
    restart: unless-stopped
    deploy:
      placement:
        constraints:
          - node.role == manager

  # ==========================================================================
  # MONITORING (Frontend-specific)
  # ==========================================================================
  frontend-monitor:
    image: nginx/nginx-prometheus-exporter:0.11.0
    container_name: musicstream-frontend-monitor
    command:
      - '-nginx.scrape-uri'
      - 'http://frontend:8080/nginx_status'
    ports:
      - "9113:9113"
    networks:
      - frontend-prod-network
    restart: unless-stopped
    depends_on:
      - frontend

  # ==========================================================================
  # LOG COLLECTOR (Optional)
  # ==========================================================================
  fluent-bit:
    image: fluent/fluent-bit:2.1.9
    container_name: musicstream-frontend-fluentbit
    volumes:
      - ./fluent-bit/fluent-bit.conf:/fluent-bit/etc/fluent-bit.conf
      - ./fluent-bit/parsers.conf:/fluent-bit/etc/parsers.conf
    networks:
      - frontend-prod-network
    restart: unless-stopped
    deploy:
      mode: global

# ============================================================================
# VOLUMES
# ============================================================================
volumes:
  traefik_letsencrypt:
    driver: local

# ============================================================================
# NETWORKS
# ============================================================================
networks:
  frontend-prod-network:
    driver: bridge
    name: musicstream-frontend-prod-network
    ipam:
      config:
        - subnet: 172.22.0.0/16