# ============================================================
# nginx/conf.d/default.conf
# Configuración del servidor virtual para React SPA
# ============================================================

# ============================================================
# SERVIDOR HTTP
# ============================================================
server {
    listen 3000 default_server;
    listen [::]:3000 default_server;

    server_name _;
    
    # Zona de rate limiting
    limit_req zone=general burst=100 nodelay;

    # Raíz del documento (donde están los archivos de React)
    root /usr/share/nginx/html;
    index index.html index.htm;

    # ========================================================
    # HEADERS DE SEGURIDAD
    # ========================================================
    
    # Prevenir clickjacking
    add_header X-Frame-Options "SAMEORIGIN" always;
    
    # Prevenir MIME sniffing
    add_header X-Content-Type-Options "nosniff" always;
    
    # Protección XSS
    add_header X-XSS-Protection "1; mode=block" always;
    
    # Referrer Policy
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    
    # Política de seguridad de contenido (CSP)
    # Ajusta según tus necesidades
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' *.google-analytics.com *.googletagmanager.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data: https://fonts.gstatic.com; connect-src 'self' https://www.google-analytics.com https://www.googletagmanager.com; frame-ancestors 'self';" always;

    # Información del servidor (seguridad)
    server_tokens off;

    # ========================================================
    # LOGS
    # ========================================================
    access_log /dev/stdout main;
    error_log /dev/stderr warn;

    # ========================================================
    # HEALTH CHECK - Para Cloud Run
    # ========================================================
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type "text/plain";
    }

    # ========================================================
    # READINESS CHECK
    # ========================================================
    location /ready {
        access_log off;
        if (-f /usr/share/nginx/html/index.html) {
            return 200 "ready\n";
        }
        return 503 "not ready\n";
        add_header Content-Type "text/plain";
    }

    # ========================================================
    # ARCHIVOS ESTÁTICOS CON CACHÉ LARGO
    # ========================================================
    # Los archivos con hash en el nombre nunca cambiarán
    # Ejemplo: main.abc123def456.js
    
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        # Expresión regular para detectar hashes en nombres
        if ($request_filename ~ "\\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$") {
            # Si tiene hash (múltiples puntos), cachear 1 año
            if ($request_filename ~ "[a-f0-9]{8,}\\.(js|css)$") {
                expires 1y;
                add_header Cache-Control "public, immutable";
            }
        }

        # Fallback: cachear 7 días
        expires 7d;
        add_header Cache-Control "public";
        add_header Pragma "public";
        
        access_log off;
    }

    # ========================================================
    # ASSETS DE PRODUCCIÓN
    # ========================================================
    location ^~ /static/ {
        # Archivos en /static/ (React build)
        expires 1y;
        add_header Cache-Control "public, immutable";
        
        # Gzip estos archivos
        gzip on;
        gzip_types text/plain text/css application/json application/javascript;
        
        access_log off;
    }

    # ========================================================
    # HTML - SIEMPRE FRESCO (no cachear)
    # ========================================================
    location ~* \.html?$ {
        expires epoch;
        add_header Cache-Control "no-cache, no-store, must-revalidate, proxy-revalidate, max-age=0";
        add_header Pragma "no-cache";
        add_header Expires "0";
    }

    # ========================================================
    # REESCRIBIR PARA REACT ROUTER
    # ========================================================
    # Todas las rutas desconocidas van a index.html
    # Así React Router puede manejarlas
    location / {
        # Intentar servir archivo, si no existe ir a index.html
        try_files $uri $uri/ /index.html;
        
        # No cachear HTML
        expires -1;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }

    # ========================================================
    # APIs - REESCRIBIR A BACKENDS
    # ========================================================
    # Ejemplo: /api/catalog -> catalog-service
    
    location /api/catalog/ {
        proxy_pass https://catalog-service-${REGION}.run.app/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_redirect off;
        
        # Timeout para APIs
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    location /api/user/ {
        proxy_pass https://user-service-${REGION}.run.app/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_redirect off;
        
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    location /api/analytics/ {
        proxy_pass https://analytics-service-${REGION}.run.app/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_redirect off;
        
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    # ========================================================
    # WEBSOCKETS (SI USAS)
    # ========================================================
    # Descomentar si tienes WebSockets
    #
    # location /ws {
    #     proxy_pass http://backend;
    #     proxy_http_version 1.1;
    #     proxy_set_header Upgrade $http_upgrade;
    #     proxy_set_header Connection "upgrade";
    #     proxy_set_header Host $host;
    #     proxy_set_header X-Real-IP $remote_addr;
    #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #     proxy_read_timeout 86400;
    # }

    # ========================================================
    # ERROR PAGES
    # ========================================================
    error_page 404 /index.html;
    error_page 500 502 503 504 /50x.html;
    
    location = /50x.html {
        root /usr/share/nginx/html;
        internal;
    }

    # ========================================================
    # DENY ACCESS - Archivos sensibles
    # ========================================================
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    location ~ ~$ {
        deny all;
        access_log off;
        log_not_found off;
    }

    # ========================================================
    # CHARSET
    # ========================================================
    charset utf-8;
    charset_types text/css text/xml text/plain text/vnd.wap.wml application/x-javascript application/rss+xml text/javascript;
}

# ============================================================
# NOTAS Y CONFIGURACIÓN
# ============================================================
#
# 1. REACT ROUTER:
#    - try_files $uri $uri/ /index.html
#    - Permite que React Router maneje todas las rutas
#
# 2. CACHÉ:
#    - Archivos con hash: 1 año (public, immutable)
#    - HTML: Sin caché (siempre fresco)
#    - Assets: 7 días
#
# 3. SEGURIDAD:
#    - Headers X-Frame-Options, X-Content-Type-Options
#    - CSP para evitar inyección de scripts
#    - Deniega acceso a archivos ocultos
#
# 4. LOGS:
#    - /dev/stdout para Cloud Logging
#    - Formato customizado con tiempos
#
# 5. GZIP:
#    - Comprime text, css, javascript
#    - Mejora rendimiento ~70%
#
# 6. APIs:
#    - Reescribe /api/catalog -> catalog-service
#    - Proxy reverso hacia backends en Cloud Run
#    - NOTA: Necesitas actualizar ${REGION}
#
# 7. VARIABLES:
#    - ${REGION} debe ser reemplazada en build
#    - O usar valor fijo como 'us-central1'
#
# ============================================================